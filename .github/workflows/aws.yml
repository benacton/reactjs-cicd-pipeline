name: Deploy to Amazon EC2

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the files
        uses: actions/checkout@v3

      - name: Create SSH Key File
        run: |
          echo "${{ secrets.AWS_SSH_KEY }}" > ~/.ssh/aws_key.pem
          chmod 600 ~/.ssh/aws_key.pem

      - name: Deploy to EC2
        env:
          HOST: ${{ secrets.EC2_IP }}
          USER: ${{ secrets.EC2_USER }}
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/aws_key.pem ${{ env.USER }}@${{ env.HOST }} << 'EOF'
            # Check if the /var/www directory exists, create if it doesn't
            if [ ! -d /var/www ]; then
              sudo mkdir /var/www
            fi
            
            # Ensure the current user has write permissions
            sudo chown $USER:$USER /var/www
            
            # Create the index.html file
            cd /var/www
            touch index.html
            
            # Set appropriate permissions
            sudo chmod 644 index.html
          EOF
